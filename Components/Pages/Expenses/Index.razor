@page "/Expenses"
@using AccountingForDentists.Components.Pages.Shared.DetailsFilter
@using AccountingForDentists.Components.Shared
@using AccountingForDentists.Infrastructure
@using AccountingForDentists.Models
@using Microsoft.AspNetCore.WebUtilities
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<AccountingContext> contextFactory
@inject NavigationManager navigationManager

<PageTitle>Expenses</PageTitle>

<div class="mx-10">
    <h1 class="font-bold text-4xl pt-5 pb-5">Expenses</h1>
    <hr />
    <DetailsFilterComponent BusinessOptions="@BusinessOptions" FYOptions="@FYOptions" SelectedFY="@FY"
        SelectedBusinesses="@Business">
    </DetailsFilterComponent>

    <hr class="my-4"/>
    @foreach (var model in ExpenseEntities ?? Enumerable.Empty<ExpensesEntity>())
    {

        <DataListLayout>
            <Header>@model.DateReference.Date.ToString("dd/MM/yyyy")</Header>
            <SecondaryHeader>
            <span class="font-bold">@model.BusinessName </span>
            @if (!string.IsNullOrWhiteSpace(model.Description))
            {   
                <span> - </span> <span class="font-extralight">@model.Description</span>
            }
            </SecondaryHeader>
            <PrimaryValue>
                $@model.Amount.ToString("#,##0.00")
            </PrimaryValue>
            <ButtonBar>
                <a href="@EditUri(model)" class="btn btn-outline p-2 h-10 w-10"><span class="icon-[material-symbols--edit] w-8 h-8"> </span>
                </a>
            </ButtonBar>
        </DataListLayout>
        <hr class="my-4"/>
    }

</div>

@code {
    [Parameter][SupplyParameterFromQuery] public int[] FY { get => field ?? []; set; }
    [Parameter][SupplyParameterFromQuery] public string[] Business { get; set; } = [];

    List<ExpensesEntity>? ExpenseEntities { get; set; }

    int[] FYOptions { get; set; } = [];
    string[] BusinessOptions { get; set; } = new string[] { "Business A", "Business B" };

    protected override async Task OnInitializedAsync()
    {
        await InitialiseFYOptions();
        await IntitialiseBusinessOptions();
        await LoadExpenseData();
        await base.OnInitializedAsync();
    }

    private async Task LoadExpenseData()
    {
        using var context = await contextFactory.CreateDbContextAsync();
        IQueryable<ExpensesEntity>? entitiesQuery = context.Expenses
        .Include(x => x.DateReference)
        .Include(x => x.Attachment)
        .Where(x => Business.Length == 0 || Business.Contains(x.BusinessName.Trim()));

        if (FY.Length > 0)
        {
            entitiesQuery = entitiesQuery.Where(x => FY.Contains(x.DateReference.Date.AddMonths(6).Year));
        }

        ExpenseEntities = await entitiesQuery.OrderByDescending(x => x.DateReference.Date).ToListAsync();

    }
    private async Task InitialiseFYOptions()
    {
        const int numberOfFY = 10;
        var maxFY = DateTime.Now.AddMonths(6).Year;
        var minFY = maxFY - 9;
        FYOptions = new int[numberOfFY];
        for (int i = minFY, j = 0; i <= maxFY; i++, j++)
        {
            FYOptions[j] = i;
        }
        FYOptions = FYOptions.OrderByDescending(x => x).ToArray();
    }

    private async Task IntitialiseBusinessOptions()
    {
        using var context = await contextFactory.CreateDbContextAsync();
        string[] businessesEntities = await context.Expenses
        .Select(x => x.BusinessName.Trim())
        .Where(x => !string.IsNullOrWhiteSpace(x))
        .OrderBy(x => x)
        .Distinct()
        .ToArrayAsync();
        BusinessOptions = businessesEntities;
    }

    private string EditUri(ExpensesEntity item) {
        string currentBaseUri = navigationManager.ToAbsoluteUri(navigationManager.Uri).GetLeftPart(UriPartial.Path);
        string editUri = $"{currentBaseUri}/Edit/{item.ExpensesId}";
        return editUri.ToString();
    }
}