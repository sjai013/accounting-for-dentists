@page "/Sales"
@using AccountingForDentists.Components.Pages.Shared.DetailsFilter
@using AccountingForDentists.Components.Shared
@using AccountingForDentists.Infrastructure
@using AccountingForDentists.Models
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<AccountingContext> contextFactory
@inject NavigationManager navigationManager


<PageTitle>Sales</PageTitle>

<div class="mx-10">
    <PageTitleComponent Title="Sales">
        <Button>
            <ActionButtonComponent Text="Add" Uri="/Sales/Add" Icon="material-symbols--add-2-rounded" />
        </Button>
    </PageTitleComponent>
    <hr />
    <DetailsFilterComponent BusinessOptions="@BusinessOptions" FYOptions="@FYOptions" SelectedFY="@FY"
        SelectedBusinesses="@Business">
    </DetailsFilterComponent>

     <hr class="my-4"/>
    @foreach (var model in SalesEntities ?? Enumerable.Empty<SalesEntity>())
    {

        <DataListLayout>
            <Header>@model.DateReference.Date.ToString("dd/MM/yyyy")</Header>
            <SecondaryHeader>
            <span class="font-bold">@model.BusinessName </span>
            @if (!string.IsNullOrWhiteSpace(model.Description))
            {   
                <span> - </span> <span class="font-extralight">@model.Description</span>
            }
            </SecondaryHeader>
            <PrimaryValue>
                $@model.Amount.ToString("#,##0.00")
            </PrimaryValue>
            <ButtonBar>
                <a href="@BuildUri(model, "Edit")" class="btn btn-outline p-2 h-10 w-10"><span class="icon-[material-symbols--edit] w-8 h-8"> </span>
                </a>
                <a href="@BuildUri(model, "Delete")" class="btn btn-outline p-2 h-10 w-10"><span class="icon-[material-symbols--delete-outline-rounded] w-8 h-8"></span></a>
            </ButtonBar>
        </DataListLayout>
        <hr class="my-4"/>
    }
</div>

@code {
    [Parameter][SupplyParameterFromQuery] public int[] FY { get => field ?? []; set; }
    [Parameter][SupplyParameterFromQuery] public string[] Business { get; set; } = [];


    List<SalesEntity>? SalesEntities { get; set; }

    int[] FYOptions { get; set; } = [];
    string[] BusinessOptions { get; set; } = [];

    protected override async Task OnInitializedAsync()
    {
        await InitialiseFYOptions();
        await IntitialiseBusinessOptions();
        await LoadSalesData();
        await base.OnInitializedAsync();
    }

    private async Task LoadSalesData()
    {
        using var context = await contextFactory.CreateDbContextAsync();
        IQueryable<SalesEntity>? entitiesQuery = context.Sales
        .Include(x => x.DateReference)
        .Include(x => x.Attachment)
        .Where(x => Business.Length == 0 || Business.Contains(x.BusinessName.Trim()));

        if (FY.Length > 0)
        {
            entitiesQuery = entitiesQuery.Where(x => FY.Contains(x.DateReference.Date.AddMonths(6).Year));
        }

        SalesEntities = await entitiesQuery.OrderByDescending(x => x.DateReference.Date).ToListAsync();

    }
    private async Task InitialiseFYOptions()
    {
        const int numberOfFY = 10;
        var maxFY = DateTime.Now.AddMonths(6).Year;
        var minFY = maxFY - 9;
        FYOptions = new int[numberOfFY];
        for (int i = minFY, j = 0; i <= maxFY; i++, j++)
        {
            FYOptions[j] = i;
        }
        FYOptions = FYOptions.OrderByDescending(x => x).ToArray();
    }

    private async Task IntitialiseBusinessOptions()
    {
        using var context = await contextFactory.CreateDbContextAsync();
        string[] businessesEntities = await context.Sales
        .Select(x => x.BusinessName.Trim())
        .Where(x => !string.IsNullOrWhiteSpace(x))
        .OrderBy(x => x)
        .Distinct()
        .ToArrayAsync();
        BusinessOptions = businessesEntities;
    }

    private string BuildUri(SalesEntity item, string action) {
        string currentBaseUri = navigationManager.ToAbsoluteUri(navigationManager.Uri).GetLeftPart(UriPartial.Path);
        string uri = $"{currentBaseUri}/{action}/{item.SalesId}";
        return uri.ToString();
    }
}